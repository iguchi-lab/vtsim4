# 温熱計算プログラムvtsim4の使い方

---
## 1.はじめに

  vtsimは、建築環境工学・建築設備を学ぶ大学生、研究者向けに開発された温熱計算プログラムで、下記の特徴があります。

*   ブラウザ上（Google Clab）で動作する。環境設定が不要。
*   自由度の高いプログラム言語pythonで記述。
*   計算 速度が求められる計算部分はc++で記述。
*   ユーザーは、プログラム言語pythonに加え、pythonのライブラリpandasなどの知識が必要。
*   熱・換気回路網による計算をベースとし、節点（ノード）と回路網（ネットワーク）、各種条件の設定で動作。

---
## 2.インストール方法

  Google Colabで下記のコードを実行して、インストールします。

```
!pip install git+https://github.com/iguchi-lab/vtsim4
from vtsim import vtsim as vt
```
  あわせて下記も実行しておくことを便利です。

  ※matplotlibは、グラフをの描画に必要。japanize-matplotlibで、日本語にも対応できます。

  ※numpyとpandasは、行列などを扱う際に必要です。

```
!pip install japanize-matplotlib
import matplotlib.pyplot as plt
import japanize_matplotlib

import numpy as np
import pandas as pd
```

---
## 3.vtsim関連モジュールの構成

  vtsimは、下記のモジュールで構成されます。

- vtsim

  vtsim本体の計算機能（vtsimのc++モジュールを動かす）
- archenvlib

  各種物理定数の他、湿り空気、太陽位置、直散分離、快適性などを計算
- fan_sts

  送風ファンのPQ特性
- cof_ground

  地盤の応答係数
- material

  建築材料と壁面構成

---
## 4.vtsimでできること

ノードとネットワークの構成により、下記のような様々な計算が可能です。

- 換気回路網計算による、多数室、部位間の空気の移動
- 熱回路網計算による、多数室、部位間の温度や熱流
- 空気と共に移動する物質の室内濃度

![ノードとネットワークの設定例](sample01.png)

---
## 5.計算の流れ

計算は下記の通り行われます。

#### ① ノードとネットワークの読み込みと、タイムステップの設定

    ※vtsimでは、JSON方式もしくは、pythonの辞書型（dict）でデータを読み込みます。

#### ② 換気回路網計算で各節点の圧力を計算する


#### ③ 熱回路網計算で各節点の温度を計算する


#### ④ 換気回路網と熱回路網の計算の結果、圧力と温度の変化量が十分小さくなるまで繰り返し収束させる


#### ⑤ 濃度計算により各節点の濃度を計算する


#### ⑥ タイムステップ分計算を行う

    タイムステップは、任意の時間間隔（一定である必要があります）で任意の長さを設定できます。

#### ⑦ 計算結果を出力する

    計算結果は、pandas.DataFrame形式で出力される他、csvファイル、matplolibtによるグラフで出力されます。


  ※換気回路網計算、熱回路網計算および濃度計算は、計算の設定が無い場合はスキップされます。

---
## 6. 収束計算の方法

圧力と温度の収束計算は、下記の通り行います。連立方程式の解法には、LU分解法かSOR法が選択できます。

![収束計算の方法](sample02.png)

---
## 7. 入力方法 

vtsimでは、JSON方式もしくは、pythonの辞書型（dict）でデータを読み込みます。JSON方式もしくは、pythonの辞書型（dict）は、中括弧「 { } 」を使って記述され、引用符「 ' ' 」で囲まれたキー(key)と、コロン「 : 」の後に続く値(value)で記述されます。要素と要素の間は、カンマ「 , 」で区切ります。値(value)には定数、変数の他、リスト形式(pythonでは、各括弧「 [ ] 」で囲まれ、数字の羅列などを格納)の他辞書型を格納することができ、汎用性に富んでいます。また、記述方法がJSON形式とほぼ同じであるため互換性が高く、入力内容をJSON方式で記録して、やり取りすることが容易です。

```
input = {'AAA': vvv,
         'BBB': [A, b, c, d]...}
```


## 8. 計算条件の設定
* index

vtsimは、indexの設定が必須です。indexは、時刻を表す文字列のリスト形式でpandas.to_datetimeで時刻として認識できることが必須条件です。 '2022/02/20 22:22:22' のように '%Y/%m/%d %H:%M:%S' 形式であると無難でしょう。エクセル等で作成されたcsvファイルでも、最も左にある列をこの方式で保存しておけばvtsimで読み込むことが可能です。vtsimでは、1番目と2番目の時刻から時間間隔を、indexの長さから計算するデータ長さを決定しています。

```
input = {'index': ['2022/02/20 22:22:22', '2022/02/20 22:22:23', ...]}
```

* calc_sts

vtsimの計算条件の設定です。辞書型(dict)で以下の設定を行うことができます。

  - solve
    - 連立方程式の解法を選択します。省略した場合はLU分解法が採用されます。
      - LU分解法の場合、 0 または vt.solve_LU、SOR法の場合、 1 または vt.solve_SOR を設定する。

  - step_p
    - 換気回路網計算時の偏微分で傾きを求める際の、圧力の微小変化量を設定します。省略すると、1e-6が設定されます。

  - vent_err
    - 換気回路網計算時の許容残差を設定します。省略すると、1e-6が設定されます。

  - step_t
    - 熱回路網計算時の偏微分で傾きを求める際の、温度の微小変化量を設定します。省略すると、1e-6が設定されます。

  - thrm_err
    - 換気回路網計算時の許容残差を設定します。省略すると、1e-6が設定されます。

  - conv_err
    - 換気回路網、熱回路網計算後の圧力と温度の収束判定に用いる許容変化量です。省略すると、1e-6が設定されます。

  - sor_ratio
    - SOR法で連立方程式を解く際の、緩和係数を設定します。省略すると0.9が設定されます。

  - sor_err
    - SOR法で連立方程式を解く際の、収束判定に用いる許容残差です。省略すると、1e-6が設定されます。

```
input = {'calc_sts': {
          'solve':  vt.soive_LU,
          'step_p': 1e-3
          ...
         }
        }
```

# 9. ノードの設定

* sn

ノード(sim_node)の設定を行います。
