# 温熱計算プログラムvtsim4の使い方

---
## 1.はじめに

  vtsimは、建築環境工学・建築設備を学ぶ大学生、研究者向けに開発された温熱計算プログラムで、下記の特徴があります。

*   ブラウザ上（Google Clab）で動作する。環境設定が不要。
*   自由度の高いプログラム言語pythonで記述。
*   計算 速度が求められる計算部分はc++で記述。
*   ユーザーは、プログラム言語pythonに加え、pythonのライブラリpandasなどの知識が必要。
*   熱・換気回路網による計算をベースとし、節点（ノード）と回路網（ネットワーク）、各種条件の設定で動作。

---
## 2.インストール方法

  Google Colabで下記のコードを実行して、インストールします。

```
!pip install git+https://github.com/iguchi-lab/vtsim4
from vtsim import vtsim as vt
```
  あわせて下記も実行しておくことを便利です。

  ※matplotlibは、グラフをの描画に必要。japanize-matplotlibで、日本語にも対応できます。

  ※numpyとpandasは、行列などを扱う際に必要です。

```
!pip install japanize-matplotlib
import matplotlib.pyplot as plt
import japanize_matplotlib

import numpy as np
import pandas as pd
```

---
## 3.vtsim関連モジュールの構成

  vtsimは、下記のモジュールで構成されます。

|モジュール名|内容|
|:--:|:--|
|vtsim|vtsim本体の計算機能（vtsimのc++モジュールを動かす）|
|archenvlib|各種物理定数の他、湿り空気、太陽位置、直散分離、快適性などを計算|
|fan_sts|送風ファンのPQ特性|
|cof_ground|地盤の応答係数|
|material|建築材料と壁面構成|

---
## 4.vtsimによる計算の基本的な考え方

ノードとネットワークの構成により、下記のような様々な計算が可能です。

- 換気回路網計算による、多数室、部位間の空気の移動
- 熱回路網計算による、多数室、部位間の温度や熱流
- 空気と共に移動する物質の室内濃度

![ノードとネットワークの設定例](sample01.png)

---
## 5.計算の流れ

計算は下記の通り行われます。

#### ① ノードとネットワークの読み込みと、タイムステップの設定

  - ※vtsimでは、JSON方式もしくは、pythonの辞書型（dict）でデータを読み込みます。

#### ② 換気回路網計算で圧力、熱回路網計算で温度を計算。変化量が小さくなるまで繰り返す


#### ③ 濃度計算により各節点の濃度を計算する


#### ④ 設定されたタイムステップの分だけ計算を繰り返す

  - 次のタイムステップでは、現在のタイムステップの状態を初期値として、新しい計算が行われます。
  - タイムステップは任意の時間間隔（一定である必要があります）で任意の長さを設定できます。

#### ⑤ 計算結果を出力する

  - 計算結果は、pandas.DataFrame形式で出力される他、csvファイル、matplolibtによるグラフで出力されます。


  ※換気回路網計算、熱回路網計算および濃度計算は、計算の設定が無い場合はスキップされます。

---
## 6. 収束計算の方法

圧力と温度の収束計算は、下記の通り行います。連立方程式の解法には、LU分解法かSOR法が選択できます。

![収束計算の方法](sample02.png)

---
## 7. 入力方法 

vtsimでは、JSON方式もしくは、pythonの辞書型（dict）でデータを読み込みます。JSON方式もしくは、pythonの辞書型（dict）は、中括弧「 { } 」を使って記述され、引用符「 ' ' 」で囲まれたキー(key)と、コロン「 : 」の後に続く値(value)で記述されます。要素と要素の間は、カンマ「 , 」で区切ります。値(value)には定数、変数の他、リスト形式(pythonでは、各括弧「 [ ] 」で囲まれ、数字の羅列などを格納)の他辞書型を格納することができ、汎用性に富んでいます。また、記述方法がJSON形式とほぼ同じであるため互換性が高く、入力内容をJSON方式で記録して、やり取りすることが容易です。pythonの辞書型(dict)は、重複したキーを設定することができないため注意が必要です。

```
input = {
  'AAA': vvv,
  'BBB': [A, b, c, d]...
}
```


## 8. 計算条件の設定

### index

indexは、計算対象の時刻のリストで実際の日時が用いられます。indexからタイムステップと時間間隔が抽出されるため、入力が必須になっています。また、indexは、時刻を表す文字列のリスト形式でpandas.to_datetimeで時刻として認識できることが必須条件です。 '2022/02/20 22:22:22' のように '%Y/%m/%d %H:%M:%S' 形式であると無難でしょう。エクセル等で作成されたcsvファイルでも、最も左にある列をこの方式で保存しておけばvtsimで読み込むことが可能です。vtsimでは、1番目と2番目の時刻から時間間隔を、indexの長さから計算するデータ長さを決定しています。

```
input = {
  'index': ['2022/02/20 22:22:22', '2022/02/20 22:22:23', ...]
}
```

### calc_sts

calc_stsでvtsimの計算条件を設定します。辞書型(dict)で以下の設定を行うことができます。

|設定項目|内容|設定値|省略時の設定|
|:--:|:--|:--:|:--:|
|solve|連立方程式の解法|LU分解法： 0 か vt.solve_LU<br>SOR法： 1 か vt.solve_SORを設定|LU分解法|
|step_p|換気回路網計算時の偏微分で傾きを求める際の、<br>圧力の微小変化量|数値|1e-6|
|vent_err|換気回路網計算時の許容残差|数値|1e-6|
|step_t|熱回路網計算時の偏微分で傾きを求める際の、<br>温度の微小変化量|数値|1e-6|
|thrm_err|換気回路網計算時の許容残差|数値|1e-6|
|conv_err|換気回路網、熱回路網計算後の<br>圧力と温度の収束判定に用いる許容変化量|数値|1e-6|
|sor_ratio|SOR法で連立方程式を解く際の、緩和係数|数値|0.9|
|sor_err|SOR法で連立方程式を解く際の、<br>収束判定に用いる許容残差|数値|1e-6|
```
input = {
  'calc_sts': {
    'solve':  vt.soive_LU,
    'step_p': 1e-3,
    ...
  }
}
```

### opt

optでvtsimの出力方法を設定します。
|設定項目|設定値|
|:--:|:--:|
|pandas.DataFrame のみの出力|0 または vt.OPT_DF|
|さらにcsvファイルを出力|1 または vt.OPT_CSV|
|加えてグラフを出力|2 または vt.OPT_GRAPH|
```
input = {
  'opt': 0
}
```

# 9. ノードの設定

### sn

snでノード(sim_node)の設定を行います。ノードは、ノード名をキー(key)とした辞書型(dict)で設定します。値は数値（例えば、0.0や1.0など）もしくはリスト（[0.0, 1.0, ...]）で設定することができます。リストでの設定も可である値を数値で設定した場合、自動的にデータ長さ分のリストに変換され設定がされます。t_flagをvt.SN_CALCに設定してs_iに親ノード名を指定すると、親ノードの1ステップ前の温度を継承する特殊なノードを作成することができます。ノードにcapaを設定した場合、t_flagをvt.SN_CALC、親ノード名を自ノードとした子ノードが自動的に追加され、さらに自ノードと子ノードの間に熱容量に相当する熱コンダクタンスが設定されて、熱容量を再現できることができるようになります（詳細については後述）。

※ノード名中の「 」（空白）は無視されます。また、ノード名のうち「 : 」の後の文字は無視されます（メモ書きとして利用可能です）。

※ノード名の文字列は、「 , 」で区切ることで、複数のノードに同じ値を設定することができます。
```
input = {
  'sn': {
    'nodeA, nodeB, nodeC': {
      't_flag': vt.SN_CALC
    }
    'nodeD : memo': {
      't_flag': vt.SN_FIX,
      't': 20.0
    }
  }
}
```

|設定項目|内容|値|省略時の設定|
|:--:|:--|:--|:--:|
|v_flag|換気回路網計算における圧力の計算|計算なし：0 か vt.SN_NONE<br>計算する：1 か vt.SN_CALC<br>固定値：2 か vt.SN_FIX|計算なし|
|t_flag|熱回路網計算における圧力の計算|計算なし：0 か vt.SN_NONE<br>計算する：1 か vt.SN_CALC<br>固定値：2 か vt.SN_FIX<br>遅延：3 か vt.DLY|計算なし|
|c_flag|濃度計算における圧力の計算|計算なし：0 か vt.SN_NONE<br>計算する：1 か vt.SN_CALC<br>固定値：2 か vt.SN_FIX|計算なし|
|p|圧力 [Pa]|数値（リストでの設定も可）|0.0|
|t|温度 [℃]|数値（リストでの設定も可）|20.0|
|c|濃度 [個/L]|数値（リストでの設定も可）|0.0|
|isolation|日射量 [W/m<sup>2</sup>]|数値（リストでの設定も可）|なし|
|h_input|発熱量 [W]|数値（リストでの設定も可）|なし|
|v|気積 [m3<sup>3</sup>] （濃度計算用）|数値（リストでの設定も可）|なし|
|m|粉塵発生量 [個/s]|数値（リストでの設定も可）|なし|
|beta|沈着係数 [1/s]|数値（リストでの設定も可）|なし|
|s_i|親ノードのノード名|ノード名の文字列|なし|
|capa|熱容量 [J/K]|数値|なし|

# 10. 換気回路網の設定

### vn

vnで換気回路網の設定を行います。換気回路網は、「->」を挟んで始点と終点のノード名を記述（例えば「node1 -> node2」）したキー(key)とした辞書型(dict)で設定します。値(value)は数値（例えば、0.0や1.0など）もしくはリスト（[0.0, 1.0, ...]）で設定することができます。リストでの設定も可である値を数値で設定した場合、自動的にデータ長さ分のリストに変換され設定がされます。値(value)に記載された内容によって、自動的にどのような回路網が設定されたか判別されます。

※ネットワーク名中の「 」（空白）は無視されます。また、ネットワーク名のうち「 : 」の後の文字は無視されます（メモ書きとして利用可能です）。

※「node1 -> node2 -> node3」のような記述により、「node1 -> node2」と「node2 -> node3」に同じ値を設定することが可能です。

※ネットワーク名の文字列は、「 , 」で区切ることで、複数のネットワークに同じ値を設定することができます。

```
input = {
  'vn': {
    'nodeA -> nodeB, nodeA -> nodeC : memo': {
      'vol': 0.500
    }
    'node1 -> node2 -> node 3 : memo': {
      'vol': 5.777
    }
  }
}
```

### 共通
vnの設定では、共通して以下の項目の設定が必要です。
|設定項目|内容|値|省略時の設定|
|:--:|:--|:--|:--:|
|h1|始点の高さ [m]|数値（リストでの設定も可）|0.0|
|h2|終点の高さ [m]|数値（リストでの設定も可）|0.0|
|eta|除去効率（濃度計算用） [-]|数値（リストでの設定も可）|なし|

### 単純開口 vt.VT_SIMPLE
alphaとareaが設定されている場合、単純開口の認識されます。
|設定項目|内容|値|
|:--:|:--|:--|
|alpha|流量計数 [-]|数値（リストでの設定も可）|
|area|面積 [m<sup>2</sup>]|数値（リストでの設定も可）|

### 隙間 vt.VT_GAP
aとnが設定されている場合、隙間と認識されます。
|設定項目|内容|値|
|:--:|:--|:--|
|a|通気率 [-]|数値（リストでの設定も可）|
|n|隙間特性値 [-]|数値（リストでの設定も可）|

### 固定風量 vt.VT_FIX
volが設定されている場合、固定風量と認識されます。
|設定項目|内容|値|
|:--:|:--|:--|
|vol|送風量 [m<sup>3</sup>/s]|数値（リストでの設定も可）|

### エアコン vt.VT_AIRCON
ac_volが設定されている場合、エアコンと認識されます。エアコンは、換気回路網上は固定風量と変わりませんが、空気の移動に伴う熱流は0とする特殊ネットワークです。熱回路網にもエアコンを設定することによって、エアコンを再現することができます。
|設定項目|内容|値|
|:--:|:--|:--|
|ac_vol|送風量 [m<sup>3</sup>/s]|数値（リストでの設定も可）|

### 送風ファン vt.VT_FAN
qmaxとpmaxが設定されている場合、送風ファンと認識されます。設定される送風ファンは、(0, qmax)、(p1, q1)および(pmax, 0)の3点を通るPQ特性となります。
|設定項目|内容|値|
|:--:|:--|:--|
|qmax|圧力損失最大値 [Pa]|数値（リストでの設定も可）|
|pmax|風量最大値 [m<sup>3</sup>/s]||数値（リストでの設定も可）|
|q1|ある点の圧力損失 [Pa]|数値（リストでの設定も可）|
|p1|ある点の風量 [m<sup>3</sup>/s]|数値（リストでの設定も可）|

# 11. 換気回路網の設定

### tn

tnで熱回路網の設定を行います。熱回路網は、「->」を挟んで始点と終点のノード名を記述（例えば「node1 -> node2」）したキー(key)とした辞書型(dict)で設定します。値(value)は数値（例えば、0.0や1.0など）もしくはリスト（[0.0, 1.0, ...]）で設定することができます。リストでの設定も可である値を数値で設定した場合、自動的にデータ長さ分のリストに変換され設定がされます。値(value)に記載された内容によって、自動的にどのような回路網が設定されたか判別されます。

※ネットワーク名中の「 」（空白）は無視されます。また、ネットワーク名のうち「 : 」の後の文字は無視されます（メモ書きとして利用可能です）。

※ネットワーク名の文字列は、「 , 」で区切ることで、複数のネットワークに同じ値を設定することができます。

```
input = {
  'tn': {
    'nodeA -> nodeB, nodeA -> nodeC : memo': {
      'cdtc': 0.500
    }
  }
}
```

